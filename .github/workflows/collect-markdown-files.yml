name: Collect Markdown Files

on:
  push:
    branches:
      - 'feature/**'

jobs:
  collect-markdown-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get markdown files in entries
        id: changed_markdown_files
        shell: bash
        run: |
          set -euo pipefail

          BEFORE_SHA="${{ github.event.before }}"
          CURRENT_SHA="${{ github.sha }}"
          EMPTY_TREE_SHA="0000000000000000000000000000000000000000"

          if [[ "$BEFORE_SHA" == "$EMPTY_TREE_SHA" ]]; then
            changed_files=$(git diff-tree --no-commit-id --name-only -r "$CURRENT_SHA" -- 'entries/**')
          else
            changed_files=$(git diff --name-only "$BEFORE_SHA" "$CURRENT_SHA" -- 'entries/**')
          fi

          markdown_files=()
          while IFS= read -r file; do
            [[ -z "$file" ]] && continue
            [[ "$file" != *.md ]] && continue
            markdown_files+=("$file")
          done <<< "$changed_files"

          echo "MARKDOWN_FILES=${markdown_files[*]}" >> "$GITHUB_OUTPUT"

      - name: Show markdown files output
        run: |
          echo "MARKDOWN_FILES: ${{ steps.changed_markdown_files.outputs.MARKDOWN_FILES }}"
